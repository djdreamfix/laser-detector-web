<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>OBD Analyzer</title>

<style>
  :root{
    --bg:#f9f9fb; --card:#ffffff; --text:#111; --muted:#6b7280; --border:#e5e7eb;
    --accent:#007aff; --accent-d:#0051a8; --badge:#eef2ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial,sans-serif;}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);
    padding:14px 16px;text-align:center;font-weight:600;font-size:18px}
  main{padding:16px;max-width:760px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;
    box-shadow:0 2px 10px rgba(0,0,0,0.04);margin-bottom:16px}
  .title{font-weight:600;font-size:16px;margin-bottom:8px}
  .subtitle{font-size:13px;color:var(--muted);margin-top:4px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:12px 14px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:8px 12px}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;background:var(--badge)}
  .divider{height:1px;background:var(--border);margin:12px 0}
  canvas#previewCanvas{width:100%;border-radius:12px;background:#fff;border:1px solid var(--border);display:block}
  video{max-width:100%;border-radius:12px;background:#000;display:block}
  .pill{display:inline-block;padding:4px 8px;border-radius:20px;background:#eef2ff;margin:2px 6px 0 0}
  details.debug{margin-top:10px;border:1px solid #ddd;border-radius:10px;background:#fff;padding:8px}
  details.debug summary{cursor:pointer;color:var(--accent);font-weight:600}
  details.debug pre{margin-top:8px;padding:8px;background:#f7f7f7;border-radius:8px;font-family:Menlo,SFMono-Regular,monospace;white-space:pre-wrap;word-break:break-word}
  .hidden{display:none !important}
  @media (max-width: 768px) {
     .btn {
       padding: 16px 20px; / –ë—ñ–ª—å—à—ñ –∫–Ω–æ–ø–∫–∏ /
       font-size: 18px;
     }
     .card {
       padding: 20px; / –ë—ñ–ª—å—à–µ –º—ñ—Å—Ü—è /
     }
   }
  img.crop-target {
  max-width: 100%;
  max-height: 70vh;
  object-fit: contain;
  display: block;
  margin: 0 auto;
  border-radius: 12px;
}
.crop-container {
  position: relative;
  max-height: 80vh;
  overflow: auto;
  padding: 12px;
  background: #fff;
  border-radius: 12px;
  border: 1px solid var(--border);
  margin-bottom: 16px;
}
.crop-container img {
  max-width: 100%;
  max-height: 70vh;
  object-fit: contain;
  border-radius: 12px;
  display: block;
  margin: 0 auto;
}
.crop-container canvas {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 10;
}

#previewCanvas {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 10;
}



</style>

<!-- Cropper + Tesseract 
<link href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet" />
<script src="https://unpkg.com/cropperjs@2.1.0/dist/cropper.min.js" defer></script>
<script src="https://unpkg.com/cropperjs@1.5.12/dist/cropper.min.js"></script>-->

<script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>

<!-- dev tools -->
<script src="https://unpkg.com/eruda"></script><script>eruda.init();</script>

</head>
<body>
<header>OBD Analyzer</header>
<main>

  <!-- Upload / Camera -->
  <div class="card">
    <div class="title">–î–æ–¥–∞–π —Ñ–æ—Ç–æ –µ–∫—Ä–∞–Ω—É —Å–∫–∞–Ω–µ—Ä–∞</div>
    <div class="subtitle">OCR ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ (V519) ‚Üí –ø–æ—Ä–∞–¥–∏ ‚Üí –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ DTC</div>

    <div style="margin-top:10px" class="controls">
      <input id="filePicker" type="file" accept="image/*" style="display:none" />
      <button id="btnPick" class="btn">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
      <button id="btnOpenCamera" class="btn secondary">–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫–∞–º–µ—Ä—É</button>
      <button id="btnCapture" class="btn secondary hidden">–ó–∞—Ö–æ–ø–∏—Ç–∏ –∫–∞–¥—Ä</button>
      <button id="btnCrop" class="btn secondary hidden">–û–±—Ä—ñ–∑–∞—Ç–∏</button>
      <button id="btnStopCamera" class="btn secondary hidden">–ó—É–ø–∏–Ω–∏—Ç–∏ –∫–∞–º–µ—Ä—É</button>
      <button id="useDemo" class="btn secondary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥–µ–º–æ</button>
    </div>

    <div class="small muted" style="margin-top:8px">–ü–æ—Ä–∞–¥–∞: —Ñ–æ—Ç–æ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ, –±–µ–∑ –≤—ñ–¥–±–ª–∏—Å–∫—ñ–≤; –ø—ñ–¥–≤–∏—â—É–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ.</div>
<div id="cropContainer" class="crop-container hidden"></div>

    <div style="margin-top:12px">
      <video id="video" autoplay playsinline class="hidden"></video>
      <canvas id="previewCanvas" class="hidden "></canvas>
    </div>
  </div>

  <!-- Result -->
  <div class="card" id="resultCard">
    <div class="title">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
    <div class="subtitle" id="statusText">–ì–æ—Ç–æ–≤–æ</div>
    <div id="quickSummary" style="margin-top:8px"></div>
    <div class="divider"></div>
    <div class="kv" id="kv"></div>
    <div class="divider"></div>
    <div class="title">–ü–æ—Ä–∞–¥–∏</div>
    <ul id="advice" style="list-style:none;padding:0;margin:8px 0"></ul>
  </div>

  <!-- Charts -->
  <div class="card">
    <div class="title">–ì—Ä–∞—Ñ—ñ–∫–∏ (–æ—Å—Ç–∞–Ω–Ω—ñ –¥–∞–Ω—ñ)</div>
    <div class="subtitle">RPM, ECT, MAP, MAF, TPS</div>
    <canvas id="chartRPM"></canvas>
    <canvas id="chartECT" style="margin-top:10px"></canvas>
    <canvas id="chartMAP" style="margin-top:10px"></canvas>
    <canvas id="chartMAF" style="margin-top:10px"></canvas>
    <canvas id="chartTPS" style="margin-top:10px"></canvas>
  </div>

  <!-- DTC Base -->
  <div class="card">
    <div class="title">–õ–æ–∫–∞–ª—å–Ω–∞ –±–∞–∑–∞ DTC</div>
    <div class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø–æ–≤–Ω—é—î—Ç—å—Å—è –ø—Ä–∏ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—ñ –Ω–æ–≤–∏—Ö –∫–æ–¥—ñ–≤</div>
    <div class="kv" id="dtcBaseView"></div>
    <div style="margin-top:8px" class="controls">
      <button id="downloadDB" class="btn secondary">–ï–∫—Å–ø–æ—Ä—Ç –±–∞–∑–∏ (JSON)</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="importBtn" class="btn secondary">–Ü–º–ø–æ—Ä—Ç –±–∞–∑–∏</button>
    </div>
  </div>

</main>


<script>

/* ========= IndexedDB (—è–∫ —É —Ç–≤–æ—î–º—É —Ñ–∞–π–ª—ñ) ========= */
let db;
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('obd_app_db', 3);
    req.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains('dtc')) db.createObjectStore('dtc', { keyPath: 'code' });
      if (!db.objectStoreNames.contains('series')) db.createObjectStore('series', { keyPath: 'id' });
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(db); };
    req.onerror = (e) => reject(e);
  });
}
async function openDBIfNeeded(){ if(!db) await openDB(); }
async function dbPut(store, obj){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(obj);
    tx.oncomplete=()=>resolve(true);
    tx.onerror=(e)=>reject(e);
  });
}
async function dbGet(store, key){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=(e)=>reject(e);
  });
}
async function dbGetAll(store){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=(e)=>reject(e);
  });
}
async function dbDeleteAll(store){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(store,'readwrite');
    const req=tx.objectStore(store).clear();
    req.onsuccess=()=>resolve(true);
    req.onerror=(e)=>reject(e);
  });
}

/* ========= Seed families (—è–∫ –±—É–≤) ========= */
async function seedFamilies(){
  const families = [
    { code:'P03xx', name:'–ü—Ä–æ–ø—É—Å–∫–∏ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è', desc:'–í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–ø—É—Å–∫–∏ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–≤—ñ—á–∫–∏, –∫–æ—Ç—É—à–∫–∏, –¥—Ä–æ—Ç–∏.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä—Å—É–Ω–∫–∏ —Ç–∞ –∫–æ–º–ø—Ä–µ—Å—ñ—é.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è."
    ]},
    { code:'P0171', name:'–ó–±—ñ–¥–Ω–µ–Ω–∞ —Å—É–º—ñ—à (Bank 1)', desc:'PCM –≤–∏—è–≤–∏–≤ –∑–±—ñ–¥–Ω–µ–Ω—É —Å—É–º—ñ—à.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è, –≤–∞–∫—É—É–º–Ω—ñ —à–ª–∞–Ω–≥–∏.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ MAF/MAP.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–∏—Å–∫ –ø–∞–ª–∏–≤–∞."
    ]},
    { code:'P0172', name:'–ó–±–∞–≥–∞—á–µ–Ω–∞ —Å—É–º—ñ—à (Bank 1)', desc:'PCM –≤–∏—è–≤–∏–≤ –∑–±–∞–≥–∞—á–µ–Ω—É —Å—É–º—ñ—à.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–ø—ñ–¥—Ç—ñ–∫–∞–Ω–Ω—è).",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä —Ç–∏—Å–∫—É.",
      "–û—Ü—ñ–Ω–∏—Ç–∏ —Ä–æ–±–æ—Ç—É O2/AFR."
    ]},
    { code:'P0420', name:'–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–∞—Ç–∞–ª—ñ–∑–∞—Ç–æ—Ä–∞ –Ω–∏–∑—å–∫–∞ (Bank 1)', desc:'–ö–∞—Ç–∞–ª—ñ–∑–∞—Ç–æ—Ä –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏—Ç–æ–∫–∏ –≤–∏—Ö–ª–æ–ø—É –ø–µ—Ä–µ–¥ –∫–∞—Ç–æ–º.",
      "–û—Ü—ñ–Ω–∏—Ç–∏ –¥–∞—Ç—á–∏–∫–∏ O2 (–¥–æ/–ø—ñ—Å–ª—è –∫–∞—Ç—É).",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—É–º—ñ—à."
    ]},
    { code:'P0103', name:'MAF ‚Äî –≤–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª—É', desc:'–í–∏—Å–æ–∫–∏–π —Å–∏–≥–Ω–∞–ª –∑ MAF (High input).', actions:[
      "–û–≥–ª—è–Ω—É—Ç–∏ –ø—Ä–æ–≤–æ–¥–∫—É MAF (–ö–ó/–æ–±—Ä–∏–≤).",
      "–û—á–∏—Å—Ç–∏—Ç–∏/–∑–∞–º—ñ–Ω–∏—Ç–∏ MAF.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥–µ—Ä–º–µ—Ç–∏—á–Ω—ñ—Å—Ç—å –≤–ø—É—Å–∫—É."
    ]}
  ];
  for (const f of families) await dbPut('dtc', f);
}

/* ========= UI refs ========= */
const filePicker = document.getElementById('filePicker');
const btnPick = document.getElementById('btnPick');
const btnOpenCamera = document.getElementById('btnOpenCamera');
const btnCapture = document.getElementById('btnCapture');
const btnStopCamera = document.getElementById('btnStopCamera');
const btnCrop = document.getElementById('btnCrop');
const btnUseDemo = document.getElementById('useDemo');
const previewCanvas = document.getElementById('previewCanvas');
const videoEl = document.getElementById('video');

const statusText = document.getElementById('statusText');
const kvEl = document.getElementById('kv');
const adviceEl = document.getElementById('advice');
const dtcBaseView = document.getElementById('dtcBaseView');
const downloadDB = document.getElementById('downloadDB');
const importFile = document.getElementById('importFile');
const importBtn = document.getElementById('importBtn');
const quickSummary = document.getElementById('quickSummary');

let cropper = null;
let tempImgEl = null;
let cameraStream = null;

/* ======= Init DB & seed ======= */
document.addEventListener('DOMContentLoaded', async ()=>{
  await openDB();
  const seeded = await dbGet('meta','seeded');
  if(!seeded){ await seedFamilies(); await dbPut('meta',{key:'seeded', value:true}); }
  await renderDTCBase();
  await refreshCharts();
});

/* ========= Utilities ========= */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function dedupe(arr){ const s=new Set(); const out=[]; for(const x of arr){ const k=String(x||'').trim(); if(!s.has(k)){ s.add(k); out.push(x); } } return out; }
function avg(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }

/* ========= Parser & helpers (–≤–∑—è—Ç–æ —ñ –∞–¥–∞–ø—Ç–æ–≤–∞–Ω–æ –∑ —Ç–≤–æ–≥–æ –∫–æ–¥—É) ========= */
async function parseV519(text){
  const out = {};
  const T = String(text || '').replace(/\s+/g,' ').trim();
  out.OCRText = T;

  const dtc = [...T.matchAll(/\b([PBCU]\d{4})\b/gi)].map(m=>m[1].toUpperCase());
  if (dtc.length) out.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫ = dtc;

  const frz = T.match(/\bDTCFRZE?F?\b[:\s]*([PBCU]\d{4})/i);
  if (frz) out.FreezeFrameDTC = frz[1].toUpperCase();

  const rpm = T.match(/\bRPM\b[:\s]*(-?\d{2,5})/i);
  if (rpm) out.–û–±–æ—Ä–æ—Ç–∏ = +rpm[1];

  const ect = T.match(/\b(ECT|ETC|Coolant)\s*[:\s]*(-?\d{1,5})/i);
  if (ect){ const val=+ect[2]; if(val>-40 && val<150) out.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ = val; }

  const iat = T.match(/\b(IAT|Intake Air Temp)\s*[:\s]*(-?\d{1,5})/i);
  if (iat){ const val=+iat[2]; if(val>-40 && val<100) out.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–í–ø—É—Å–∫—É = val; }

  const eot = T.match(/\b(EOT|Engine Oil Temp)\s*[:\s]*(-?\d{1,5})/i);
  if (eot){ const val=+eot[2]; if(val>-40 && val<180) out.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ª–∏–≤–∏ = val; }

  const load = T.match(/\bLOAD[_\s]?PCT`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (load) out.–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–í—ñ–¥—Å–æ—Ç–æ–∫ = +load[1];

  const tps = T.match(/\b(TPS|Throttle)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (tps) out.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫ = +tps[2];

  const map = T.match(/\bMAP\b.*?[:\s]*(-?\d{1,3}(?:\.\d{1,3})?)\s?(kPa|inHg)?/i);
  if (map) out.–¢–∏—Å–∫MAP = +(map[1]);

  const maf = T.match(/\bMAF\b.*?[:\s]*(-?\d{1,3}(?:\.\d{1,3})?)\s?g\/s/i);
  if (maf) out.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs = +maf[1];

  const fs1 = T.match(/\bFUELSYS[1!]\b[:\s]*(CL|OL|NA|OK|-?\d{1,3})/i);
  if (fs1) out.–ü–∞–ª–∏–≤–Ω–∞–°–∏—Å—Ç–µ–º–∞1 = fs1[1].toUpperCase();
  const fs2 = T.match(/\bFUELSYS[2?]\b[:\s]*(CL|OL|NA|OK|-?\d{1,3})/i);
  if (fs2) out.–ü–∞–ª–∏–≤–Ω–∞–°–∏—Å—Ç–µ–º–∞2 = fs2[1].toUpperCase();

  const stft1 = T.match(/\b(SHRTFT1|STFT1)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (stft1) out.STFT1 = +stft1[2];
  const stft2 = T.match(/\b(SHRTFT2|STFT2)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (stft2) out.STFT2 = +stft2[2];
  const ltft1 = T.match(/\b(LONGFT1|LTFT1)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (ltft1) out.LTFT1 = +ltft1[2];
  const ltft2 = T.match(/\b(LONGFT2|LTFT2)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (ltft2) out.LTFT2 = +ltft2[2];

  const o2s = [...T.matchAll(/\bO2.*?(B\d).*?(S\d).*?[:\s]*([0-1](?:\.\d{1,3})?)V/gi)];
  o2s.forEach(m => { out[`O2_${m[1]}${m[2]}_V`] = +m[3]; });

  const afr = T.match(/\b(AFR|Lambda)\b[:\s]*(-?\d{1,2}\.\d{1,3})/i);
  if (afr) out.AFR = +afr[2];

  const volt = T.match(/\b(Battery|Voltage)\b[:\s]*([0-9]{1,2}\.?[0-9])\s?V\b/i);
  if (volt) out.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë = +volt[2];

  const spd = T.match(/\b(Speed|VSS)\b[:\s]*(-?\d{1,3})\s?(km\/h|mph)?/i);
  if (spd){ out.–®–≤–∏–¥–∫—ñ—Å—Ç—å = +spd[2]; out.–û–¥–∏–Ω–∏—Ü—ñ–®–≤–∏–¥–∫–æ—Å—Ç—ñ = spd[3] || 'km/h'; }

  const imPairs = [...T.matchAll(/\b(Misfire Monitor|Fuel System Mon|Catalyst Mon|Evap System Mon|O2 Sensor Mon|O2 Sensor Htr|EGR System)\b[:\s]*(OK|INC|NA|OFF|ON)\b/gi)];
  if (imPairs.length) out.IMReadiness = imPairs.map(m=>({name:m[1], status:m[2].toUpperCase()}));

  const testVal = T.match(/\bTest\s*value\b[:\s]*([-\d\.]+)/i);
  const minLim  = T.match(/\bMin\s*Limit\b[:\s]*([-\d\.]+)/i);
  const maxLim  = T.match(/\bMax\s*Limit\b[:\s]*([-\d\.]+)/i);
  const status  = T.match(/\bStatus\b[:\s]*(Fail|Pass|OK)/i);
  if (testVal || minLim || maxLim || status) {
    out.Mode6 = {
      testValue: testVal ? +testVal[1] : null,
      min: minLim ? +minLim[1] : null,
      max: maxLim ? +maxLim[1] : null,
      status: status ? status[1].toUpperCase() : null
    };
  }

  const mil = T.match(/\b(MIL|Check\s*Engine)\b.*\b(ON|OFF)\b/i);
  if (mil) out.–ú–Ü–õ = mil[2].toUpperCase();

  return out;
}

/* ========= OCR wrapper ========= */
async function runOCRFromCanvas(canvas){
  try {
    statusText.textContent = 'üîé –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è OCR‚Ä¶';
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
    const { data } = await Tesseract.recognize(blob, 'eng+rus', {
      logger: m => console.log('Tesseract', m)
    });
    statusText.textContent = '‚úÖ OCR –∑–∞–≤–µ—Ä—à–µ–Ω–æ';
    return data?.text ?? '';
  } catch (e){
    console.error('OCR error', e);
    statusText.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ OCR';
    throw e;
  }
}

/* ========= Cropper helper ========= */
let cropStartX, cropStartY, cropEndX, cropEndY;
let isCropping = false;
//let tempImgEl = null;
function startCropperFromUrl(url) {
  // –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
  if (tempImgEl) {
    tempImgEl.remove();
    tempImgEl = null;
  }
  // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
tempImgEl = document.createElement('img');
tempImgEl.src = url;
tempImgEl.className = 'crop-target';

  tempImgEl.style.maxWidth = '90vw';
  tempImgEl.style.maxHeight = '70vh';
  tempImgEl.style.display = 'block';
  tempImgEl.style.touchAction = 'none'; // –í–∞–∂–ª–∏–≤–æ –¥–ª—è —Ç–æ—Ä—á-–ø–æ–¥—ñ–π
  const container = document.getElementById('cropContainer');
container.innerHTML = ''; // –æ—á–∏—â–∞—î –ø–æ–ø–µ—Ä–µ–¥–Ω—î
container.classList.remove('hidden');
container.appendChild(tempImgEl);
previewCanvas.width = tempImgEl.naturalWidth;
previewCanvas.height = tempImgEl.naturalHeight;
container.appendChild(previewCanvas);

const wrapper = document.createElement('div');
wrapper.className = 'crop-container';
wrapper.appendChild(tempImgEl);
document.body.appendChild(wrapper);
  
   // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É "–û–±—Ä—ñ–∑–∞—Ç–∏"
  btnCrop.classList.remove('hidden');
  statusText.textContent = '–í–∏–¥—ñ–ª—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±—Ä—ñ–∑–∫–∏ (–ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –ø–∞–ª—å—Ü–µ–º)';
  // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø—ñ–≤ —ñ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
  tempImgEl.onload = () => {
    // –î–ª—è –º–∏—à—ñ
    tempImgEl.onmousedown = handleStart;
    tempImgEl.onmousemove = handleMove;
    tempImgEl.onmouseup = handleEnd;
    
    // –î–ª—è —Ç–æ—Ä—á-–ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
    tempImgEl.ontouchstart = handleStart;
    tempImgEl.ontouchmove = handleMove;
    tempImgEl.ontouchend = handleEnd;
  };
  function handleStart(e) {
    isCropping = true;
    const pos = getPosition(e);
    cropStartX = pos.x;
    cropStartY = pos.y;
    e.preventDefault(); // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö
  }
  function handleMove(e) {
    if (!isCropping) return;
    const pos = getPosition(e);
    cropEndX = pos.x;
    cropEndY = pos.y;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–∞–º–∫–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
    updateSelectionBox();
    e.preventDefault();
  }
  function handleEnd() {
    isCropping = false;
  }
  function getPosition(e) {
    let clientX, clientY;
    
    if (e.type.includes('touch')) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    
    const rect = tempImgEl.getBoundingClientRect();
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  }
  function updateSelectionBox() {
    const previewCtx = previewCanvas.getContext('2d');
    previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    
    // –ú–∞–ª—é—î–º–æ –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω
    previewCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
    
    // –ú–∞–ª—é—î–º–æ "–≤–∏—Ä—ñ–∑–∞–Ω—É" –æ–±–ª–∞—Å—Ç—å
    previewCtx.clearRect(
      cropStartX,
      cropStartY,
      cropEndX - cropStartX,
      cropEndY - cropStartY
    );
    
    // –ú–∞–ª—é—î–º–æ —Ä–∞–º–∫—É
    previewCtx.strokeStyle = 'red';
    previewCtx.lineWidth = 2;
    previewCtx.strokeRect(
      cropStartX,
      cropStartY,
      cropEndX - cropStartX,
      cropEndY - cropStartY
    );
  }
}

/* ========= Unified flow: pick file -> crop -> OCR -> parse -> render ========= */
btnPick.addEventListener('click', ()=>filePicker.click());

filePicker.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  startCropperFromUrl(url);
});

/* Crop button: take cropped canvas, show preview, OCR, parse, save */
btnCrop.addEventListener('click', async () => {
  if (!tempImgEl || !cropStartX || !cropStartY || !cropEndX || !cropEndY) {
    statusText.textContent = '–°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥—ñ–ª—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å!';
    return;
  }

  // –û–±—á–∏—Å–ª—é—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –æ–±—Ä—ñ–∑–∫–∏
  const width = Math.abs(cropEndX - cropStartX);
  const height = Math.abs(cropEndY - cropStartY);
  const x = Math.min(cropStartX, cropEndX);
  const y = Math.min(cropStartY, cropEndY);

  // –û–±—Ä—ñ–∑–∞—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  const croppedCanvas = document.createElement('canvas');
  croppedCanvas.width = width;
  croppedCanvas.height = height;
  const ctx = croppedCanvas.getContext('2d');
  ctx.drawImage(
    tempImgEl,
    x, y, width, height,  // –û–±—Ä—ñ–∑–∞–Ω–∞ –æ–±–ª–∞—Å—Ç—å
    0, 0, width, height   // –ù–æ–≤–∏–π canvas
  );

  // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É previewCanvas
  previewCanvas.width = croppedCanvas.width;
  previewCanvas.height = croppedCanvas.height;
  previewCanvas.getContext('2d').drawImage(croppedCanvas, 0, 0);
  previewCanvas.classList.remove('hidden');

  // –û—á–∏—â—É—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
  tempImgEl.remove();
  tempImgEl = null;
  btnCrop.classList.add('hidden');
  statusText.textContent = '–û–±—Ä—ñ–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±—Ä–æ–±–ª—è—î–º–æ OCR...';

  // –î–∞–ª—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ OCR (—è–∫ —É –≤–∞—à–æ–º—É –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É –∫–æ–¥—ñ)
  const text = await runOCRFromCanvas(previewCanvas);
  const parsed = await parseV519(text);
  // ... —Ä–µ—à—Ç–∞ –ª–æ–≥—ñ–∫–∏
});


/* ========= Camera flow (open, capture, stop) ========= */
btnOpenCamera.addEventListener('click', async ()=>{
  try {
    if (cameraStream) stopCamera();
    cameraStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    videoEl.srcObject = cameraStream;
    videoEl.classList.remove('hidden');
    btnCapture.classList.remove('hidden');
    btnStopCamera.classList.remove('hidden');
    statusText.textContent = '–ö–∞–º–µ—Ä–∞ —É–≤—ñ–º–∫–Ω–µ–Ω–∞. –ù–∞–≤–µ–¥–∏ –Ω–∞ –µ–∫—Ä–∞–Ω —ñ –Ω–∞—Ç–∏—Å–Ω–∏ –ó–∞—Ö–æ–ø–∏—Ç–∏ –∫–∞–¥—Ä';
  } catch (e){
    console.error('camera error', e);
    statusText.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞–º–µ—Ä—É';
  }
});

btnStopCamera.addEventListener('click', ()=>stopCamera());

function stopCamera(){
  if (!cameraStream) return;
  cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream = null;
  videoEl.pause();
  videoEl.srcObject = null;
  videoEl.classList.add('hidden');
  btnCapture.classList.add('hidden');
  btnStopCamera.classList.add('hidden');
  statusText.textContent = '–ö–∞–º–µ—Ä–∞ –∑—É–ø–∏–Ω–µ–Ω–∞';
}

btnCapture.addEventListener('click', ()=>{
  if (!videoEl || videoEl.readyState < 2) { statusText.textContent='–ö–∞–¥—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'; return; }
  // draw to offscreen canvas then start cropper from data URL
  const tmp = document.createElement('canvas');
  tmp.width = videoEl.videoWidth;
  tmp.height = videoEl.videoHeight;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(videoEl,0,0,tmp.width,tmp.height);
  stopCamera();
  const url = tmp.toDataURL('image/png');
  startCropperFromUrl(url);
});

/* ========= Demo button (—è–∫ —É —Ç–µ–±–µ) ========= */
btnUseDemo.addEventListener('click', async ()=>{
  const demoText = `
    Data Stream
    DTC.CNT: 1
    DTCFRZF: P0012
    FUELSYS1: CL
    FUELSYS2: -4
    LOAD PCT(%): 68.2
    ETC(¬∞C): 90
    RPM: 760
    MAP(kPa): 45
    MAF(g/s): 3.2
    TPS(%): 12.0
    O2 B1 S1(V): 0.78
    O2 B1 S2(V): 0.12
    SHRTFT1(%): 2.3
    LONGFT1(%): 5.0
    SHRTFT2(%): -4.0
    LONGFT2(%): 1.0
  `;
  statusText.textContent = '–ê–Ω–∞–ª—ñ–∑—É—é –¥–µ–º–æ –¥–∞–Ω—ñ‚Ä¶';
  const parsed = await parseV519(demoText);
  const tips = await buildAdvice(parsed);
  await saveSeriesEntry(parsed);
  await renderResult(parsed, tips);
  await renderDTCBase();
  await refreshCharts();
});

/* ========= DTC ensure & fetch (—è–∫ —É —Ç–µ–±–µ, –º–∞–π–∂–µ –±–µ–∑ –∑–º—ñ–Ω) ========= */
async function ensureDTCs(codes){
  // tolerate different key names and falsy
  if(!codes || !codes.length) return;
  for(const code of codes){
    const existing = await dbGet('dtc', code);
    if (existing) continue;
    try {
      const info = await fetchDTCViaProxy(code);
      const record = {
        code,
        name: info.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–¥',
        desc: info.desc || '',
        actions: (info.actions && info.actions.length) ? info.actions : [
          "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–æ–≤–æ–¥–∫—É/—Ä–æ–∑'—î–º.",
          "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è —Å–µ–Ω—Å–æ—Ä—ñ–≤ —É Data Stream.",
          "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –≤–∏—Ä–æ–±–Ω–∏–∫–∞."
        ]
      };
      await dbPut('dtc', record);
    } catch(e){ console.warn('fetch DTC failed', e); }
  }
}

async function fetchDTCViaProxy(code){
  const target = `https://obd.avto.pro/${code.toLowerCase()}/`;
  const url = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('–ü—Ä–æ–∫—Å—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');
  const data = await res.json();
  const html = data.contents || '';
  return extractFromHTML(html);
}
function extractFromHTML(html){
  const name = extractBetween(html,'<h1','</h1>').replace(/<[^>]+>/g,'').trim() || '';
  let desc = '';
  const metaMatch = html.match(/<meta[^>]+name=["']description["'][^>]+content=["']([^"']+)["'][^>]*>/i);
  if (metaMatch) desc = metaMatch[1].trim();
  const actions = [];
  const items = html.match(/<li[^>]*>(.*?)<\/li>/gi) || [];
  items.forEach(li=>{
    const txt = li.replace(/<[^>]+>/g,'').trim();
    if (/–ø—Ä–∏—á–∏–Ω|—Å–∏–º–ø—Ç–æ–º|—Ä–µ—à–µ–Ω–∏|solution|cause|symptom|repair|diagnos|—Ä–µ–º–æ–Ω—Ç|—Å–æ–≤–µ—Ç|—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü/i.test(txt)) actions.push(txt);
  });
  return { name, desc, actions };
}
function extractBetween(html, startTag, endTag){
  const start = html.indexOf(startTag);
  if (start === -1) return '';
  const end = html.indexOf(endTag, start);
  if (end === -1) return '';
  return html.substring(start, end + endTag.length);
}

/* ========= Advice builder (adapted) ========= */
async function lookupDTC(code){
  const rec = await dbGet('dtc', code);
  if (rec) return rec;
  const fam = code.replace(/(\d)\d{2}$/, '$1xx');
  const famRec = await dbGet('dtc', fam);
  if (famRec) return famRec;
  return { code, name:"–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–¥", desc:"–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É –≤ –±–∞–∑—ñ.", actions:[
    "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ freeze frame —Ç–∞ —Å—É–ø—É—Ç–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.",
    "–ó—á–∏—Ç–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–æ–¥–∏ —ñ on-board –º–æ–Ω—ñ—Ç–æ—Ä–∏.",
    "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∂–∏–≤–ª–µ–Ω–Ω—è, –º–∞—Å—É, –ø—Ä–æ–≤–æ–¥–∫—É."
  ]};
}
function safeKey(obj, keyVariants){ for(const k of keyVariants) if(obj[k]!==undefined) return obj[k]; return undefined; }

async function buildAdvice(data){
  const tips = [];
  if (!data) return ['–ü—Ä–æ–±–ª–µ–º –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ.'];

  const dtcs = data.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫ || data.–ö–æ–¥–∏ || [];
  if (dtcs && dtcs.length){
    for(const code of dtcs){
      const info = await lookupDTC(code);
      tips.push(`–ö–æ–¥ ${code}: ${info.name}. ${info.desc || ''}`);
      (info.actions || []).forEach(a => tips.push("‚Ä¢ " + a));
    }
  }

  if (data.–ú–Ü–õ === 'ON') tips.push("MIL: ON ‚Äî —É—Å—É–Ω—å –∞–∫—Ç–∏–≤–Ω—ñ DTC —Ç–∞ –∑–∞–≤–µ—Ä—à —Ü–∏–∫–ª —ó–∑–¥–∏.");

  if (typeof data.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë === 'number'){
    if (data.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë < 11.8) tips.push("–ù–∏–∑—å–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ –ê–ö–ë: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–∫—É–º—É–ª—è—Ç–æ—Ä —Ç–∞ –∑–∞—Ä—è–¥ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞.");
    else if (data.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë > 14.8) tips.push("–í–∏—Å–æ–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ –ê–ö–ë: –º–æ–∂–ª–∏–≤–∏–π –ø–µ—Ä–µ–∑–∞—Ä—è–¥ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä.");
  }

  if (typeof data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ === 'number'){
    if (data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ > 115) tips.push("–ü–µ—Ä–µ–≥—Ä—ñ–≤: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç, –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∏, —Ä—ñ–≤–µ–Ω—å –∞–Ω—Ç–∏—Ñ—Ä–∏–∑—É.");
  }

  if (Array.isArray(data.IMReadiness)){
    const inc = data.IMReadiness.filter(x=>x.status==='INC');
    if (inc.length) tips.push(`–ú–æ–Ω—ñ—Ç–æ—Ä–∏ –Ω–µ –≥–æ—Ç–æ–≤—ñ: ${inc.map(x=>x.name).join(', ')}.`);
  }

  if (data.Mode6 && data.Mode6.status){
    if (data.Mode6.status === 'FAIL') tips.push("Mode 6: —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Test/Min/Max.");
    else tips.push("Mode 6: —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω–æ.");
  }

  return dedupe(tips);
}

/* ========= Series & Charts (—è–∫ —É —Ç–µ–±–µ) ========= */
async function saveSeriesEntry(parsed){
  const entry = { id: crypto.randomUUID(), ts: Date.now(), screenType: 'data_stream', data: parsed };
  await dbPut('series', entry);
  return entry;
}
async function getRecentSeries(limit=60){
  const all = await dbGetAll('series');
  return all.slice(-limit);
}
function plotLine(canvasEl, values, color='#007aff', labelMin='min', labelMax='max'){
  const cvs = canvasEl;
  const ctx = cvs.getContext('2d');
  const w = cvs.width = cvs.clientWidth;
  const h = cvs.height = 180;
  ctx.clearRect(0,0,w,h);
  if (!values.length) {
    ctx.fillStyle = '#999'; ctx.font = '12px system-ui'; ctx.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞', 12, 24); return;
  }
  const min = Math.min(...values), max = Math.max(...values);
  const pad = 10;
  ctx.strokeStyle = '#e5e7eb';
  ctx.beginPath(); ctx.moveTo(pad, h - pad); ctx.lineTo(w - pad, h - pad); ctx.stroke();
  ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
  values.forEach((v,i)=>{
    const x = pad + (i / Math.max(1, values.length - 1)) * (w - pad*2);
    const y = pad + (1 - (v - min) / Math.max(1, (max - min))) * (h - pad*2);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle = '#6b7280'; ctx.font = '11px system-ui';
  ctx.fillText(`${labelMin} ${min.toFixed(2)}`, w - 140, h - 26);
  ctx.fillText(`${labelMax} ${max.toFixed(2)}`, w - 140, h - 12);
}
async function refreshCharts(){
  const series = await getRecentSeries(60);
  const rpmVals = series.map(s => s.data.–û–±–æ—Ä–æ—Ç–∏).filter(v => typeof v === 'number');
  const ectVals = series.map(s => s.data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ).filter(v => typeof v === 'number');
  const mapVals = series.map(s => s.data.–¢–∏—Å–∫MAP).filter(v => typeof v === 'number');
  const mafVals = series.map(s => s.data.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs).filter(v => typeof v === 'number');
  const tpsVals = series.map(s => s.data.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫).filter(v => typeof v === 'number');
  plotLine(document.getElementById('chartRPM'), rpmVals, '#d946ef');
  plotLine(document.getElementById('chartECT'), ectVals, '#2563eb');
  plotLine(document.getElementById('chartMAP'), mapVals, '#10b981');
  plotLine(document.getElementById('chartMAF'), mafVals, '#f59e0b');
  plotLine(document.getElementById('chartTPS'), tpsVals, '#8b5cf6');
}

/* ========= Render (—É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π) ========= */
function renderKV(obj){
  kvEl.innerHTML = '';
  const add = (k, v) => {
    const key = document.createElement('div'); key.textContent = k;
    const val = document.createElement('div');
    if (v && typeof v === 'object' && !Array.isArray(v)) {
      const sub = Object.entries(v).map(([kk,vv])=>`${kk}: ${vv}`).join(', ');
      val.innerHTML = `<span class="badge">${escapeHtml(sub)}</span>`;
    } else if (Array.isArray(v)) {
      if (v.length && typeof v[0] === 'object') {
        const items = v.map(item=>Object.entries(item).map(([kk,vv])=>`${kk}: ${vv}`).join(', ')).join(' | ');
        val.innerHTML = `<span class="badge">${escapeHtml(items)}</span>`;
      } else {
        val.innerHTML = `<span class="badge">${escapeHtml((v||[]).join(', '))}</span>`;
      }
    } else {
      val.innerHTML = `<span class="badge">${escapeHtml(String(v))}</span>`;
    }
    kvEl.appendChild(key); kvEl.appendChild(val);
  };

  if (!obj || !Object.keys(obj).length) { add('–°—Ç–∞—Ç—É—Å','–ù–µ–º–∞—î —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏—Ö –ø–æ–ª—ñ–≤'); return; }

  Object.entries(obj).forEach(([k,v])=>{
    if (k === 'OCRText') return;
    add(k, v);
  });

  if (obj.OCRText){
    const details = document.createElement('details');
    details.className = 'debug';
    const sum = document.createElement('summary'); sum.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ —Å–∏—Ä–∏–π OCR‚Äë—Ç–µ–∫—Å—Ç';
    const pre = document.createElement('pre'); pre.textContent = obj.OCRText;
    details.appendChild(sum); details.appendChild(pre); kvEl.appendChild(details);
  }
}

function renderAdvice(arr){
  adviceEl.innerHTML = '';
  if (!arr || !arr.length){
    const li = document.createElement('li'); li.textContent = '–ü—Ä–æ–±–ª–µ–º –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ.'; adviceEl.appendChild(li); return;
  }
  arr.forEach(x=>{ const li=document.createElement('li'); li.textContent = x; adviceEl.appendChild(li); });
}

function renderResult(parsed, tips){
  renderKV(parsed);
  renderAdvice(tips);
  quickSummary.innerHTML = '';
  statusText.textContent = '–ì–æ—Ç–æ–≤–æ';
  if (Array.isArray(parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫) && parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫.length){
    const pill = document.createElement('div'); pill.className='pill'; pill.textContent = `DTC: ${parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫.join(', ')}`; quickSummary.appendChild(pill);
  }
  if (typeof parsed.–û–±–æ—Ä–æ—Ç–∏ === 'number'){ const pill=document.createElement('div'); pill.className='pill'; pill.textContent = `RPM: ${parsed.–û–±–æ—Ä–æ—Ç–∏}`; quickSummary.appendChild(pill); }
  if (typeof parsed.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ === 'number'){ const pill=document.createElement('div'); pill.className='pill'; pill.textContent = `ECT: ${parsed.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ}¬∞C`; quickSummary.appendChild(pill); }
  if (typeof parsed.–¢–∏—Å–∫MAP === 'number'){ const pill=document.createElement('div'); pill.className='pill'; pill.textContent = `MAP: ${parsed.–¢–∏—Å–∫MAP} kPa`; quickSummary.appendChild(pill); }
  if (typeof parsed.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs === 'number'){ const pill=document.createElement('div'); pill.className='pill'; pill.textContent = `MAF: ${parsed.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs} g/s`; quickSummary.appendChild(pill); }
  if (typeof parsed.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫ === 'number'){ const pill=document.createElement('div'); pill.className='pill'; pill.textContent = `TPS: ${parsed.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫}%`; quickSummary.appendChild(pill); }
}

/* ========= DTC base render & import/export ========= */
async function renderDTCBase(){
  dtcBaseView.innerHTML = '';
  const all = await dbGetAll('dtc');
  const keys = all.map(x=>x.code).sort();
  if (!keys.length){
    const d1=document.createElement('div'); d1.textContent='‚Äî'; dtcBaseView.appendChild(d1);
    const d2=document.createElement('div'); d2.textContent='–ë–∞–∑–∞ –ø–æ—Ä–æ–∂–Ω—è'; dtcBaseView.appendChild(d2);
    return;
  }
  keys.slice(0,30).forEach(code=>{
    const rec = all.find(x=>x.code===code);
    const kEl=document.createElement('div'); kEl.textContent=code;
    const vEl=document.createElement('div'); vEl.innerHTML=`<span class="badge">${escapeHtml(rec.name||'')}</span> <div class="small">${escapeHtml(rec.desc||'')}</div>`;
    dtcBaseView.appendChild(kEl); dtcBaseView.appendChild(vEl);
  });
  if (keys.length>30){
    const mk=document.createElement('div'); mk.textContent='‚Ä¶'; dtcBaseView.appendChild(mk);
    const mv=document.createElement('div'); mv.textContent=`–ü–æ–∫–∞–∑–∞–Ω–æ 30 –∑ ${keys.length}`; dtcBaseView.appendChild(mv);
  }
}

downloadDB.addEventListener('click', async ()=>{
  const dtc = await dbGetAll('dtc'); const series = await dbGetAll('series');
  const payload = { dtc, series, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='obd_analyzer_db.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  try {
    const data = JSON.parse(text);
    await dbDeleteAll('dtc'); await dbDeleteAll('series');
    if (Array.isArray(data.dtc)) for (const rec of data.dtc) await dbPut('dtc', rec);
    if (Array.isArray(data.series)) for (const s of data.series) await dbPut('series', s);
    await renderDTCBase(); await refreshCharts();
    alert('–Ü–º–ø–æ—Ä—Ç –≤–∏–∫–æ–Ω–∞–Ω–æ');
  } catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É'); }
});

/* ========= Helper small fixes ========= */
// compatibility with different OCR key names
async function ensureDTCsFlexible(parsed){
  const codes = parsed?.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫ || parsed?.–ö–æ–¥–∏ || parsed?.–ö–æ–¥—ã || [];
  await ensureDTCs(codes);
}

/* ========= Old handlers cleanup: none left ========= */
</script>
</body>
</html>