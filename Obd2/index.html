<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>OBD Analyzer</title>
<style>
  :root {
    color-scheme: light;
    --bg:#f9f9fb; --card:#ffffff; --text:#111; --muted:#6b7280; --border:#e5e7eb;
    --accent:#007aff; --accent-d:#0051a8;
    --ok:#e8fff0; --warn:#fff7e6; --fail:#ffecec; --badge:#eef2ff;
  }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, sans-serif; }
  header { position: sticky; top: 0; z-index: 10; background: var(--card); border-bottom: 1px solid var(--border);
    padding: 14px 16px; text-align:center; font-weight:600; font-size:18px; }
  main { padding: 16px; max-width: 760px; margin: 0 auto; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04); margin-bottom: 16px; }
  .title { font-weight: 600; font-size: 16px; margin-bottom: 8px; }
  .subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; }
  .btn { display:block; width:100%; padding:14px; border:none; border-radius:12px; font-size:16px; font-weight:600;
    background:var(--accent); color:#fff; text-align:center; }
  .btn:active { background: var(--accent-d); }
  .btn-secondary { background:#fff; color:var(--accent); border:1px solid var(--accent); }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .kv { display:grid; grid-template-columns: 180px 1fr; gap:8px 12px; }
  .badge { display:inline-block; padding:4px 8px; border-radius:8px; background:var(--badge); }
  .list { list-style: none; margin:0; padding:0; }
  .list li { margin: 6px 0; }
  .muted { color: var(--muted); }
  .pill { display:inline-block; padding:4px 8px; border-radius:20px; background:#eef2ff; margin:2px 4px 0 0; }
  canvas { width:100%; height:180px; background:#fff; border:1px solid var(--border); border-radius:12px; }
  .divider { height:1px; background:var(--border); margin:12px 0; }
  .small { font-size: 12px; color: var(--muted); }
</style>
<link  href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/cropperjs"></script>
</head>
<body>
<header>OBD Analyzer</header>
<main>

  <!-- Upload -->
  <div class="card">
    <div class="title">–î–æ–¥–∞–π —Ñ–æ—Ç–æ –µ–∫—Ä–∞–Ω—É —Å–∫–∞–Ω–µ—Ä–∞</div>
    <div class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ: OCR ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ (V519) ‚Üí –ø–æ—Ä–∞–¥–∏ ‚Üí –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ DTC</div>
    <input id="file" type="file" accept="image/*" capture="environment" class="btn" />
    <div class="row" style="margin-top:8px">
      <button id="useDemo" class="btn btn-secondary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥–µ–º–æ</button>
    </div>
    <div class="small muted" style="margin-top:8px">–ü–æ—Ä–∞–¥–∞: —Ä–æ–±–∏ —Ñ–æ—Ç–æ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ, –±–µ–∑ –≤—ñ–¥–±–ª–∏—Å–∫—ñ–≤. OCR: eng+rus.</div>
  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–æ—Ç–æ –∑ –≥–∞–ª–µ—Ä–µ—ó -->
<input type="file" id="fileInput" accept="image/*" style="display:none;">
<button id="pickPhotoBtn">üì∑ –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ–±—Ä—ñ–∑–∫–∏ -->
<button id="cropBtn" style="display:none;">–û–±—Ä—ñ–∑–∞—Ç–∏</button>

<!-- Canvas –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É -->
<canvas id="canvas"></canvas>

  </div>

  <!-- Result -->
  <div class="card" id="resultCard">
    <div class="title">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
    <div class="subtitle" id="statusText">–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–æ—Ç–æ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É‚Ä¶</div>
    <div id="quickSummary" class="row" style="margin-top:8px"></div>
    <div class="divider"></div>
    <div class="kv" id="kv"></div>
    <div class="divider"></div>
    <div class="title">–ü–æ—Ä–∞–¥–∏</div>
    <ul id="advice" class="list"></ul>
  </div>

  <!-- Charts -->
  <div class="card">
    <div class="title">–ì—Ä–∞—Ñ—ñ–∫–∏ (–æ—Å—Ç–∞–Ω–Ω—ñ –¥–∞–Ω—ñ)</div>
    <div class="subtitle">RPM, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ, —Ç–∏—Å–∫ MAP, MAF, TPS</div>
    <canvas id="chartRPM"></canvas>
    <canvas id="chartECT" style="margin-top:10px"></canvas>
    <canvas id="chartMAP" style="margin-top:10px"></canvas>
    <canvas id="chartMAF" style="margin-top:10px"></canvas>
    <canvas id="chartTPS" style="margin-top:10px"></canvas>
  </div>

  <!-- DTC Base -->
  <div class="card">
    <div class="title">–õ–æ–∫–∞–ª—å–Ω–∞ –±–∞–∑–∞ DTC</div>
    <div class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø–æ–≤–Ω—é—î—Ç—å—Å—è –ø—Ä–∏ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—ñ –Ω–æ–≤–∏—Ö –∫–æ–¥—ñ–≤</div>
    <div class="kv" id="dtcBaseView"></div>
    <div class="row" style="margin-top:8px">
      <button id="downloadDB" class="btn btn-secondary">–ï–∫—Å–ø–æ—Ä—Ç –±–∞–∑–∏ (JSON)</button>
      <input id="importFile" type="file" accept="application/json" class="btn btn-secondary" />
    </div>
  </div>

</main>
<script src="https://unpkg.com/eruda"></script>
<script>eruda.init();</script>

<script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
<script>
/* ========= IndexedDB ========= */
let db;
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('obd_app_db', 3);
    req.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains('dtc')) db.createObjectStore('dtc', { keyPath: 'code' });
      if (!db.objectStoreNames.contains('series')) db.createObjectStore('series', { keyPath: 'id' });
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(db); };
    req.onerror = (e) => reject(e);
  });
}
async function openDBIfNeeded(){ if(!db) await openDB(); }
async function dbPut(store, obj){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(obj);
    tx.oncomplete=()=>resolve(true);
    tx.onerror=(e)=>reject(e);
  });
}
async function dbGet(store, key){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=(e)=>reject(e);
  });
}
async function dbGetAll(store){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=(e)=>reject(e);
  });
}
async function dbDeleteAll(store){
  await openDBIfNeeded();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(store,'readwrite');
    const req=tx.objectStore(store).clear();
    req.onsuccess=()=>resolve(true);
    req.onerror=(e)=>reject(e);
  });
}

/* ========= Seed families ========= */
async function seedFamilies(){
  const families = [
    { code:'P03xx', name:'–ü—Ä–æ–ø—É—Å–∫–∏ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è', desc:'–í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–ø—É—Å–∫–∏ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–≤—ñ—á–∫–∏, –∫–æ—Ç—É—à–∫–∏, –¥—Ä–æ—Ç–∏.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä—Å—É–Ω–∫–∏ —Ç–∞ –∫–æ–º–ø—Ä–µ—Å—ñ—é.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è."
    ]},
    { code:'P0171', name:'–ó–±—ñ–¥–Ω–µ–Ω–∞ —Å—É–º—ñ—à (Bank 1)', desc:'PCM –≤–∏—è–≤–∏–≤ –∑–±—ñ–¥–Ω–µ–Ω—É —Å—É–º—ñ—à.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è, –≤–∞–∫—É—É–º–Ω—ñ —à–ª–∞–Ω–≥–∏.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ MAF/MAP.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–∏—Å–∫ –ø–∞–ª–∏–≤–∞."
    ]},
    { code:'P0172', name:'–ó–±–∞–≥–∞—á–µ–Ω–∞ —Å—É–º—ñ—à (Bank 1)', desc:'PCM –≤–∏—è–≤–∏–≤ –∑–±–∞–≥–∞—á–µ–Ω—É —Å—É–º—ñ—à.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä—Å—É–Ω–∫–∏ (–ø—ñ–¥—Ç—ñ–∫–∞–Ω–Ω—è).",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä —Ç–∏—Å–∫—É.",
      "–û—Ü—ñ–Ω–∏—Ç–∏ —Ä–æ–±–æ—Ç—É O2/AFR."
    ]},
    { code:'P0420', name:'–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–∞—Ç–∞–ª—ñ–∑–∞—Ç–æ—Ä–∞ –Ω–∏–∑—å–∫–∞ (Bank 1)', desc:'–ö–∞—Ç–∞–ª—ñ–∑–∞—Ç–æ—Ä –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π.', actions:[
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏—Ç–æ–∫–∏ –≤–∏—Ö–ª–æ–ø—É –ø–µ—Ä–µ–¥ –∫–∞—Ç–æ–º.",
      "–û—Ü—ñ–Ω–∏—Ç–∏ –¥–∞—Ç—á–∏–∫–∏ O2 (–¥–æ/–ø—ñ—Å–ª—è –∫–∞—Ç—É).",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—É–º—ñ—à."
    ]},
    { code:'P0103', name:'MAF ‚Äî –≤–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª—É', desc:'–í–∏—Å–æ–∫–∏–π —Å–∏–≥–Ω–∞–ª –∑ MAF (High input).', actions:[
      "–û–≥–ª—è–Ω—É—Ç–∏ –ø—Ä–æ–≤–æ–¥–∫—É MAF (–ö–ó/–æ–±—Ä–∏–≤).",
      "–û—á–∏—Å—Ç–∏—Ç–∏/–∑–∞–º—ñ–Ω–∏—Ç–∏ MAF.",
      "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥–µ—Ä–º–µ—Ç–∏—á–Ω—ñ—Å—Ç—å –≤–ø—É—Å–∫—É."
    ]}
  ];
  for (const f of families) await dbPut('dtc', f);
}

/* ========= UI refs ========= */
const fileInput = document.getElementById('file');
const statusText = document.getElementById('statusText');
const kvEl = document.getElementById('kv');
const adviceEl = document.getElementById('advice');
const dtcBaseView = document.getElementById('dtcBaseView');
const chartRPM = document.getElementById('chartRPM');
const chartECT = document.getElementById('chartECT');
const chartMAP = document.getElementById('chartMAP');
const chartMAF = document.getElementById('chartMAF');
const chartTPS = document.getElementById('chartTPS');
const useDemoBtn = document.getElementById('useDemo');
const importFile = document.getElementById('importFile');
const downloadDB = document.getElementById('downloadDB');
const quickSummary = document.getElementById('quickSummary');

document.addEventListener('DOMContentLoaded', async ()=>{
  await openDB();
  const seeded = await dbGet('meta','seeded');
  if(!seeded){ await seedFamilies(); await dbPut('meta',{key:'seeded', value:true}); }
  await renderDTCBase();
});

const fileInput = document.getElementById('fileInput');
const pickPhotoBtn = document.getElementById('pickPhotoBtn');
const cropBtn = document.getElementById('cropBtn');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let cropper;
let img;

// –Ω–∞—Ç–∏—Å–∫–∞—î—à –∫–Ω–æ–ø–∫—É ‚Üí –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –≤–∏–±—ñ—Ä —Ñ–æ—Ç–æ
pickPhotoBtn.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  img = document.createElement('img');
  img.src = URL.createObjectURL(file);
  img.style.maxWidth = '100%';
  document.body.appendChild(img);

  if (cropper) cropper.destroy();
  cropper = new Cropper(img, {
    aspectRatio: NaN,
    viewMode: 1,
    autoCropArea: 0.9,
    movable: true,
    zoomable: true,
    scalable: true
  });

  cropBtn.style.display = 'inline-block';
});

// –Ω–∞—Ç–∏—Å–∫–∞—î—à ¬´–û–±—Ä—ñ–∑–∞—Ç–∏¬ª ‚Üí –æ—Ç—Ä–∏–º—É—î—à —Ç—ñ–ª—å–∫–∏ –µ–∫—Ä–∞–Ω
cropBtn.addEventListener('click', () => {
  if (!cropper) return;
  const croppedCanvas = cropper.getCroppedCanvas();
  canvas.width = croppedCanvas.width;
  canvas.height = croppedCanvas.height;
  ctx.drawImage(croppedCanvas, 0, 0);

  // —Ç–µ–ø–µ—Ä canvas –º—ñ—Å—Ç–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –µ–∫—Ä–∞–Ω —Å–∫–∞–Ω–µ—Ä–∞
  // –ø–µ—Ä–µ–¥–∞—î–º–æ –π–æ–≥–æ –≤ OCR
  croppedCanvas.toBlob(blob => {
    // –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ —Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à Tesseract.js:
    Tesseract.recognize(blob, 'eng').then(({ data: { text } }) => {
    const parsed = parseV519(text);
    renderResult(parsed, getTips(parsed));
     });
  });

  // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ cropper
  cropper.destroy();
  img.remove();
  cropBtn.style.display = 'none';
});


/* ========= Main flow ========= */
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  statusText.textContent = '–†–æ–∑–ø—ñ–∑–Ω–∞—é —Ñ–æ—Ç–æ‚Ä¶';
  try {
    const parsed = await ocrAndParse(f);
    await ensureDTCs(parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫);
    const tips = await buildAdvice(parsed);
    await saveSeriesEntry(parsed);
    await renderResult(parsed, tips);
    await refreshCharts();
  } catch(err){
    statusText.textContent = '–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π —ñ–Ω—à–µ —Ñ–æ—Ç–æ.';
  }
});



/* Demo */
useDemoBtn.addEventListener('click', async ()=>{
  const demoText = `
    Data Stream
    DTC.CNT: 1
    DTCFRZF: P0012
    FUELSYS1: CL
    FUELSYS2: -4
    LOAD PCT(%): 68.2
    ETC(¬∞C): 90
    RPM: 760
    MAP(kPa): 45
    MAF(g/s): 3.2
    TPS(%): 12.0
    O2 B1 S1(V): 0.78
    O2 B1 S2(V): 0.12
    SHRTFT1(%): 2.3
    LONGFT1(%): 5.0
    SHRTFT2(%): -4.0
    LONGFT2(%): 1.0
  `;
  statusText.textContent = '–ê–Ω–∞–ª—ñ–∑—É—é –¥–µ–º–æ –¥–∞–Ω—ñ‚Ä¶';
  const parsed = parseV519(demoText);
  await ensureDTCs(parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫);
  const tips = await buildAdvice(parsed);
  await saveSeriesEntry(parsed);
  await renderResult(parsed, tips);
  await refreshCharts();
});





/* ========= OCR + parse (V519) ========= */
async function ocrAndParse(file){
  const img = await createImageBitmap(file);
  const canvas = document.createElement('canvas');
  canvas.width = img.width; canvas.height = img.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img,0,0);
  const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(),'eng+rus',{ });
  return parseV519(text);
}

/* ========= V519 parser: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –≤–µ—Ä—Å—ñ—è –∑ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è–º —É—Å—ñ—Ö –æ—Å–Ω–æ–≤–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ ========= */
async function parseV519(text) {
  const out = {};
  const T = text.replace(/\s+/g,' ').trim();

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–∏—Ä–∏–π OCR‚Äë—Ç–µ–∫—Å—Ç –¥–ª—è UI/–≤—ñ–¥–ª–∞–¥–∫–∏
  out.OCRText = T;

  // –ö–æ–¥–∏ DTC
  const dtc = [...T.matchAll(/\b([PBCU]\d{4})\b/gi)].map(m=>m[1].toUpperCase());
  if (dtc.length) out.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫ = dtc;

  // Freeze Frame (–≤—Ä–∞—Ö–æ–≤—É—î DTCFRZE/DTCFRZF)
  const frz = T.match(/\bDTCFRZE?F?\b[:\s]*([PBCU]\d{4})/i);
  if (frz) out.FreezeFrameDTC = frz[1].toUpperCase();

  // RPM
  const rpm = T.match(/\bRPM\b[:\s]*(-?\d{2,5})/i);
  if (rpm) out.–û–±–æ—Ä–æ—Ç–∏ = +rpm[1];

  // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ
  const ect = T.match(/\b(ECT|ETC|Coolant)\s*[:\s]*(-?\d{1,5})/i);
  if (ect) {
    const val = +ect[2];
    if (val > -40 && val < 150) out.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ = val;
  }

  // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–ø—É—Å–∫—É
  const iat = T.match(/\b(IAT|Intake Air Temp)\s*[:\s]*(-?\d{1,5})/i);
  if (iat) {
    const val = +iat[2];
    if (val > -40 && val < 100) out.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–í–ø—É—Å–∫—É = val;
  }

  // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ–ª–∏–≤–∏
  const eot = T.match(/\b(EOT|Engine Oil Temp)\s*[:\s]*(-?\d{1,5})/i);
  if (eot) {
    const val = +eot[2];
    if (val > -40 && val < 180) out.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ª–∏–≤–∏ = val;
  }

  // –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  const load = T.match(/\bLOAD[_\s]?PCT`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (load) out.–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–í—ñ–¥—Å–æ—Ç–æ–∫ = +load[1];

  // TPS
  const tps = T.match(/\b(TPS|Throttle)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (tps) out.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫ = +tps[2];

  // MAP
  const map = T.match(/\bMAP\b.*?[:\s]*(-?\d{1,3}(?:\.\d{1,3})?)\s?(kPa|inHg)?/i);
  if (map) out.–¢–∏—Å–∫MAP = map[1] + (map[2] ? ' ' + map[2] : '');

  // MAF
  const maf = T.match(/\bMAF\b.*?[:\s]*(-?\d{1,3}(?:\.\d{1,3})?)\s?g\/s/i);
  if (maf) out.MAF_gs = +maf[1];

  // FuelSys (OCR –º–æ–∂–µ –ø–ª—É—Ç–∞—Ç–∏ 1‚Üí! —ñ 2‚Üí?)
  const fs1 = T.match(/\bFUELSYS[1!]\b[:\s]*(CL|OL|NA|OK|-?\d{1,3})/i);
  if (fs1) out.–ü–∞–ª–∏–≤–Ω–∞–°–∏—Å—Ç–µ–º–∞1 = fs1[1].toUpperCase();
  const fs2 = T.match(/\bFUELSYS[2?]\b[:\s]*(CL|OL|NA|OK|-?\d{1,3})/i);
  if (fs2) out.–ü–∞–ª–∏–≤–Ω–∞–°–∏—Å—Ç–µ–º–∞2 = fs2[1].toUpperCase();

  // Fuel trims
  const stft1 = T.match(/\b(SHRTFT1|STFT1)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (stft1) out.STFT1 = +stft1[2];
  const stft2 = T.match(/\b(SHRTFT2|STFT2)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (stft2) out.STFT2 = +stft2[2];
  const ltft1 = T.match(/\b(LONGFT1|LTFT1)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (ltft1) out.LTFT1 = +ltft1[2];
  const ltft2 = T.match(/\b(LONGFT2|LTFT2)\s*`\(?%?\)`?[:\s]*(-?\d{1,3}(?:\.\d+)?)/i);
  if (ltft2) out.LTFT2 = +ltft2[2];

  // O2 —Å–µ–Ω—Å–æ—Ä–∏
  const o2s = [...T.matchAll(/\bO2.*?(B\d).*?(S\d).*?[:\s]*([0-1](?:\.\d{1,3})?)V/gi)];
  o2s.forEach(m=>{
    out[`O2_${m[1]}${m[2]}_V`] = +m[3];
  });

  // AFR / Lambda
  const afr = T.match(/\b(AFR|Lambda)\b[:\s]*(-?\d{1,2}\.\d{1,3})/i);
  if (afr) out.AFR = +afr[2];

  // –ù–∞–ø—Ä—É–≥–∞ –ê–ö–ë
  const volt = T.match(/\b(Battery|Voltage)\b[:\s]*([0-9]{1,2}\.?[0-9])\s?V\b/i);
  if (volt) out.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë = +volt[2];

  // –®–≤–∏–¥–∫—ñ—Å—Ç—å
  const spd = T.match(/\b(Speed|VSS)\b[:\s]*(-?\d{1,3})\s?(km\/h|mph)?/i);
  if (spd) { out.–®–≤–∏–¥–∫—ñ—Å—Ç—å = +spd[2]; out.–û–¥–∏–Ω–∏—Ü—ñ–®–≤–∏–¥–∫–æ—Å—Ç—ñ = spd[3] || 'km/h'; }

  // I/M Readiness
  const imPairs = [...T.matchAll(/\b(Misfire Monitor|Fuel System Mon|Catalyst Mon|Evap System Mon|O2 Sensor Mon|O2 Sensor Htr|EGR System)\b[:\s]*(OK|INC|NA|OFF|ON)\b/gi)];
  if (imPairs.length) out.IMReadiness = imPairs.map(m => ({ name: m[1], status: m[2].toUpperCase() }));

  // Mode 6 (OCR –º–æ–∂–µ —Å–ø–æ—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ Max Limit)
  const testVal = T.match(/\bTest\s*value\b[:\s]*([-\d\.]+)/i);
  const minLim  = T.match(/\bMin\s*Limit\b[:\s]*([-\d\.]+)/i);
  const maxLim  = T.match(/\b(Max|–ú–∞—Ö)\s*L(im|i—Ç|–®–ù—Ç)[a-z–π]*[:\s]*([-\d\.]+)/i);
  const status  = T.match(/\bStatus\b[:\s]*(Fail|Pass|OK)/i);
  if (testVal || minLim || maxLim || status) {
    out.Mode6 = {
      testValue: testVal ? +testVal[1] : null,
      min: minLim ? +minLim[1] : null,
      max: maxLim ? +maxLim[3] : null,
      status: status ? status[1].toUpperCase() : null
    };
  }

  // Component Test
  if (/Evaporative system leak test/i.test(T)) {
    out.ComponentTest = "EVAP Leak Test";
    const st = T.match(/\b(Pass|Fail)\b/i);
    if (st) out.ComponentStatus = st[1].toUpperCase();
  }
  if (/EGR/i.test(T) && /Component test/i.test(T)) {
    out.ComponentTest = (out.ComponentTest ? out.ComponentTest + ' + ' : '') + 'EGR Test';
  }

  // MIL
  const mil = T.match(/\b(MIL|Check\s*Engine)\b.*\b(ON|OFF)\b/i);
  if (mil) out.–ú–Ü–õ = mil[2].toUpperCase();

  // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∫—Ä–æ–∫ (–ø—Ä–∏–∫–ª–∞–¥): –æ–Ω–ª–∞–π–Ω‚Äë—Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–µ—Ä—à–æ–≥–æ DTC
  if (out.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫ && out.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫.length) {
    try {
      const code = out.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫[0];
      // –ü—Ä–∏–∫–ª–∞–¥ –º—ñ—Å—Ü—è –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –≤–ª–∞—Å–Ω–æ–≥–æ API:
      // const resp = await fetch(`https://your-dtc-api.example/${code}`);
      // if (resp.ok) {
      //   const data = await resp.json();
      //   out.DTCInfo = data.description || '';
      // }
    } catch (e) {
      console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–ø–∏—Å DTC:", e);
    }
  }

  return out;
}
/* ========= DTC online ensure ========= */
async function ensureDTCs(codes){
  if(!Array.isArray(codes) || !codes.length) return;
  for(const code of codes){
    const existing = await dbGet('dtc', code);
    if (existing) continue;
    try {
      const info = await fetchDTCViaProxy(code);
      const record = {
        code,
        name: info.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–¥',
        desc: info.desc || '',
        actions: (info.actions && info.actions.length) ? info.actions : [
          "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–æ–≤–æ–¥–∫—É/—Ä–æ–∑'—î–º –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –¥–∞—Ç—á–∏–∫—ñ–≤.",
          "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è —Å–µ–Ω—Å–æ—Ä—ñ–≤ —É Data Stream.",
          "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –≤–∏—Ä–æ–±–Ω–∏–∫–∞ (TSB)."
        ]
      };
      await dbPut('dtc', record);
      await renderDTCBase();
    } catch(e){ /* —Ç–∏—Ö–∏–π —Ñ–æ–ª–±–µ–∫ */ }
  }
}
async function fetchDTCViaProxy(code){
  const target = `https://obd.avto.pro/${code.toLowerCase()}/`;
  const url = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('–ü—Ä–æ–∫—Å—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');
  const data = await res.json();
  const html = data.contents || '';
  return extractFromHTML(html);
}
function extractFromHTML(html){
  // –ù–∞–∑–≤–∞ –∫–æ–¥—É (h1)
  const name = extractBetween(html,'<h1','</h1>').replace(/<[^>]+>/g,'').trim();

  // –ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å (meta description)
  let desc = '';
  const metaMatch = html.match(/<meta[^>]+name=["']description["'][^>]+content=["']([^"']+)["'][^>]*>/i);
  if (metaMatch) desc = metaMatch[1].trim();

  // –í–∏—Ç—è–≥—É—î–º–æ <li>, –∞–ª–µ —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ
  const actions = [];
  const items = html.match(/<li[^>]*>(.*?)<\/li>/gi) || [];
  items.forEach(li=>{
    const txt = li.replace(/<[^>]+>/g,'').trim();
    // –§—ñ–ª—å—Ç—Ä: –±–µ—Ä–µ–º–æ –ª–∏—à–µ —Ç—ñ, –¥–µ —î –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞
    if (/–ø—Ä–∏—á–∏–Ω|—Å–∏–º–ø—Ç–æ–º|—Ä–µ—à–µ–Ω–∏|solution|cause|symptom|repair|diagnos|—Ä–µ–º–æ–Ω—Ç|—Å–æ–≤–µ—Ç|—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü/i.test(txt)) {
      actions.push(txt);
    }
  });

  return { name, desc, actions };
}

function extractBetween(html, startTag, endTag){
  const start = html.indexOf(startTag);
  if (start === -1) return '';
  const end = html.indexOf(endTag, start);
  if (end === -1) return '';
  return html.substring(start, end + endTag.length);
}


/* ========= Advice ========= */
async function lookupDTC(code){
  const rec = await dbGet('dtc', code);
  if (rec) return rec;
  const fam = code.replace(/(\d)\d{2}$/, '$1xx');
  const famRec = await dbGet('dtc', fam);
  if (famRec) return famRec;
  return { code, name:"–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–¥", desc:"–ù–µ–º–∞—î –∑–∞–ø–∏—Å—É –≤ –±–∞–∑—ñ.", actions:[
    "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ freeze frame —Ç–∞ —Å—É–ø—É—Ç–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.",
    "–ó—á–∏—Ç–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–æ–¥–∏ —ñ on-board –º–æ–Ω—ñ—Ç–æ—Ä–∏.",
    "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∂–∏–≤–ª–µ–Ω–Ω—è, –º–∞—Å—É, –ø—Ä–æ–≤–æ–¥–∫—É."
  ]};
}
function dedupe(arr){ const s=new Set(); const out=[]; for(const x of arr){ const k=x.trim(); if(!s.has(k)){ s.add(k); out.push(x); } } return out; }
async function buildAdvice(data){
  const tips = [];

  // DTC based
  if (data.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫) {
    for (const code of data.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫) {
      const info = await lookupDTC(code);
      tips.push(`–ö–æ–¥ ${code}: ${info.name}. ${info.desc || ''}`.trim());
      (info.actions || []).forEach(a => tips.push("‚Ä¢ " + a));
    }
  }

  // MIL
  if (data.–ú–Ü–õ === 'ON') tips.push("MIL: ON ‚Äî —É—Å—É–Ω—å –∞–∫—Ç–∏–≤–Ω—ñ DTC —Ç–∞ –∑–∞–≤–µ—Ä—à —Ü–∏–∫–ª —ó–∑–¥–∏.");

  // Battery voltage
  if (typeof data.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë === 'number') {
    if (data.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë < 11.8) tips.push("–ù–∏–∑—å–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ –ê–ö–ë: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–∫—É–º—É–ª—è—Ç–æ—Ä —Ç–∞ –∑–∞—Ä—è–¥ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞.");
    else if (data.–ù–∞–ø—Ä—É–≥–∞–ê–ö–ë > 14.8) tips.push("–í–∏—Å–æ–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ –ê–ö–ë: –º–æ–∂–ª–∏–≤–∏–π –ø–µ—Ä–µ–∑–∞—Ä—è–¥ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä.");
  }

  // Coolant / IAT / oil temp
  if (typeof data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ === 'number') {
    if (data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ < -40 || data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ > 150) tips.push("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ –ø–æ–∑–∞ –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º ‚Äî –¥–∞—Ç—á–∏–∫/–¥–∞–Ω—ñ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ.");
    else if (data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ > 115) tips.push("–ü–µ—Ä–µ–≥—Ä—ñ–≤: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç, –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∏, —Ä—ñ–≤–µ–Ω—å –∞–Ω—Ç–∏—Ñ—Ä–∏–∑—É, —á–∏—Å—Ç–æ—Ç—É —Ä–∞–¥—ñ–∞—Ç–æ—Ä–∞.");
  }
  if (typeof data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–í–ø—É—Å–∫—É === 'number' && data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–í–ø—É—Å–∫—É > 60) {
    tips.push("–í–∏—Å–æ–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–ø—É—Å–∫—É: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–µ–ø–ª–æ–≤—ñ –µ–∫—Ä–∞–Ω–∏/–ø–æ—Ç—ñ–∫ –ø–æ–≤—ñ—Ç—Ä—è.");
  }
  if (typeof data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ª–∏–≤–∏ === 'number' && data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ª–∏–≤–∏ > 130) {
    tips.push("–í–∏—Å–æ–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ–ª–∏–≤–∏: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è —Ç–∞ —Ä–µ–∂–∏–º –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó.");
  }

  // MAP/MAF sanity
  if (typeof data.–¢–∏—Å–∫MAP_kPa === 'number') {
    if (data.–û–±–æ—Ä–æ—Ç–∏ && data.–û–±–æ—Ä–æ—Ç–∏ >= 700 && data.–¢–∏—Å–∫MAP_kPa > 60) {
      tips.push("–í–∏—Å–æ–∫–∏–π MAP –Ω–∞ —Ö–æ–ª–æ—Å—Ç–∏—Ö: –º–æ–∂–ª–∏–≤–∏–π –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è –∞–±–æ –Ω–µ–≤—ñ—Ä–Ω—ñ –ø–æ–∫–∞–∑–∞–Ω–Ω—è.");
    }
  }
  if (typeof data.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs === 'number' && typeof data.–û–±–æ—Ä–æ—Ç–∏ === 'number') {
    // –≥—Ä—É–±–∞ –æ—Ü—ñ–Ω–∫–∞: 0.8‚Äì1.2 –≥/—Å –Ω–∞ 1 –ª –¥–≤–∏–≥—É–Ω–∞ –Ω–∞ –•–• (–±–µ–∑ –æ–±'—î–º—É –¥–≤–∏–≥—É–Ω–∞ —Ä–æ–±–∏–º–æ –∑–∞–≥–∞–ª—å–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏)
    if (data.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs < 1 && data.–û–±–æ—Ä–æ—Ç–∏ < 900) {
      tips.push("–ù–∏–∑—å–∫–∏–π MAF –Ω–∞ –•–•: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è MAF/—Ñ—ñ–ª—å—Ç—Ä–∞, –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è.");
    }
  }

  // Throttle / ignition
if (
  typeof data.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫ === 'number' &&
  data.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫ > 30 &&
  (data.–û–±–æ—Ä–æ—Ç–∏ || 0) <= 1000
) {
  tips.push("–í–∏—Å–æ–∫–∏–π TPS –ø—Ä–∏ –Ω–∏–∑—å–∫–∏—Ö –æ–±–µ—Ä—Ç–∞—Ö: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–∞—Ç—á–∏–∫ TPS –∞–±–æ –º–µ—Ö–∞–Ω—ñ–∫—É –¥—Ä–æ—Å–µ–ª—è.");
}


  // Fuel trims
  const trims = [
    { k:'–ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤–∞–ö–æ—Ä–µ–∫—Ü—ñ—è1', label:'STFT1' },
    { k:'–ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤–∞–ö–æ—Ä–µ–∫—Ü—ñ—è2', label:'STFT2' },
    { k:'–î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∞–ö–æ—Ä–µ–∫—Ü—ñ—è1', label:'LTFT1' },
    { k:'–î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∞–ö–æ—Ä–µ–∫—Ü—ñ—è2', label:'LTFT2' },
  ];
  for (const t of trims) {
    const v = data[t.k];
    if (typeof v === 'number') {
      if (Math.abs(v) <= 5) tips.push(`${t.label}: –≤ –º–µ–∂–∞—Ö –Ω–æ—Ä–º–∏ (¬±5%).`);
      else if (Math.abs(v) <= 25) tips.push(`${t.label}: –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (¬±10‚Äì25%). –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥—Å–º–æ–∫ –ø–æ–≤—ñ—Ç—Ä—è, —Ç–∏—Å–∫ –ø–∞–ª–∏–≤–∞, —Ñ–æ—Ä—Å—É–Ω–∫–∏.`);
      else tips.push(`${t.label}: –∑–Ω–∞—á–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (>¬±25%). –î—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞—Ç–∏ –≤–ø—É—Å–∫/MAF, –ø–∞–ª–∏–≤–Ω–∏–π –Ω–∞—Å–æ—Å/—Ä–µ–≥—É–ª—è—Ç–æ—Ä, —Ñ–æ—Ä—Å—É–Ω–∫–∏.`);
    }
  }

  // O2 sensors behavior
  const preCat = [data.O2_B1S1_V, data.O2_B2S1_V].filter(v=>typeof v==='number');
  const postCat = [data.O2_B1S2_V, data.O2_B2S2_V].filter(v=>typeof v==='number');
  if (preCat.length && postCat.length) {
    const preAvg = avg(preCat), postAvg = avg(postCat);
    if (Math.abs(preAvg - postAvg) < 0.05) tips.push("O2 –¥–æ/–ø—ñ—Å–ª—è –∫–∞—Ç—É —Å—Ö–æ–∂—ñ ‚Äî –º–æ–∂–ª–∏–≤–∞ –Ω–∏–∑—å–∫–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–∞—Ç–∞–ª—ñ–∑–∞—Ç–æ—Ä–∞ (–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ P0420/P0430).");
  }
  preCat.forEach(v=>{
    if (v < 0.05 || v > 0.95) tips.push("O2 –ø–µ—Ä–µ–¥ –∫–∞—Ç–æ–º –∑–∞ –º–µ–∂–∞–º–∏ —Ç–∏–ø–æ–≤–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–∞—Ç—á–∏–∫/–ø—ñ–¥—ñ–≥—Ä—ñ–≤/—Å—É–º—ñ—à.");
  });

  // I/M readiness
  if (Array.isArray(data.IMReadiness)) {
    const inc = data.IMReadiness.filter(x => x.status === 'INC');
    if (inc.length) tips.push(`–ú–æ–Ω—ñ—Ç–æ—Ä–∏ –Ω–µ –≥–æ—Ç–æ–≤—ñ: ${inc.map(x=>x.name).join(', ')}. –ó–∞–≤–µ—Ä—à–∏ —Ü–∏–∫–ª —ó–∑–¥–∏ —ñ –ø–µ—Ä–µ–≤—ñ—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ.`);
  }

  // Mode 6
  if (data.Mode6 && data.Mode6.status) {
    if (data.Mode6.status === 'FAIL') tips.push("Mode 6: —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ Test/Min/Max, —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ —Å–µ–Ω—Å–æ—Ä/—Å—É–±—Ç–µ—Å—Ç, –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–∞—Ç—á–∏–∫/–ª–∞–Ω—Ü—é–≥.");
    if (data.Mode6.status === 'PASS' || data.Mode6.status === 'OK') tips.push("Mode 6: —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω–æ.");
  }

  return dedupe(tips);
}
function avg(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }

/* ========= Series & Charts ========= */
async function saveSeriesEntry(parsed){
  const entry = { id: crypto.randomUUID(), ts: Date.now(), screenType: 'data_stream', data: parsed };
  await dbPut('series', entry);
  return entry;
}
async function getRecentSeries(limit=60){
  const all = await dbGetAll('series');
  return all.slice(-limit);
}
function plotLine(canvasEl, values, color='#007aff', labelMin='min', labelMax='max'){
  const cvs = canvasEl;
  const ctx = cvs.getContext('2d');
  const w = cvs.width = cvs.clientWidth;
  const h = cvs.height = 180;
  ctx.clearRect(0,0,w,h);
  if (!values.length) {
    ctx.fillStyle = '#999';
    ctx.font = '12px system-ui';
    ctx.fillText('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞', 12, 24);
    return;
  }
  const min = Math.min(...values), max = Math.max(...values);
  const pad = 10;
  ctx.strokeStyle = '#e5e7eb';
  ctx.beginPath(); ctx.moveTo(pad, h - pad); ctx.lineTo(w - pad, h - pad); ctx.stroke();
  ctx.strokeStyle = color; ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v, i) => {
    const x = pad + (i / Math.max(1, values.length - 1)) * (w - pad*2);
    const y = pad + (1 - (v - min) / Math.max(1, (max - min))) * (h - pad*2);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.fillStyle = '#6b7280'; ctx.font = '11px system-ui';
  ctx.fillText(`${labelMin} ${min.toFixed(2)}`, w - 140, h - 26);
  ctx.fillText(`${labelMax} ${max.toFixed(2)}`, w - 140, h - 12);
}
async function refreshCharts(){
  const series = await getRecentSeries(60);
  const rpmVals = series.map(s => s.data.–û–±–æ—Ä–æ—Ç–∏).filter(v => typeof v === 'number');
  const ectVals = series.map(s => s.data.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ).filter(v => typeof v === 'number');
  const mapVals = series.map(s => s.data.–¢–∏—Å–∫MAP_kPa ?? s.data.–¢–∏—Å–∫MAP_inHg).filter(v => typeof v === 'number');
  const mafVals = series.map(s => s.data.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs).filter(v => typeof v === 'number');
  const tpsVals = series.map(s => s.data.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫).filter(v => typeof v === 'number');
  plotLine(chartRPM, rpmVals, '#d946ef', 'min', 'max');
  plotLine(chartECT, ectVals, '#2563eb', 'min', 'max');
  plotLine(chartMAP, mapVals, '#10b981', 'min', 'max');
  plotLine(chartMAF, mafVals, '#f59e0b', 'min', 'max');
  plotLine(chartTPS, tpsVals, '#8b5cf6', 'min', 'max');
}

/* ========= Render ========= */
function renderKV(obj) {
  kvEl.innerHTML = '';

  const add = (k, v) => {
    const row = document.createElement('div');

    if (v && typeof v === 'object' && !Array.isArray(v)) {
      // –≤–∫–ª–∞–¥–µ–Ω–∏–π –æ–±‚Äô—î–∫—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Mode6)
      const sub = Object.entries(v)
        .map(([kk, vv]) => `${kk}: ${vv}`)
        .join(', ');
      row.innerHTML = `<b>${k}:</b> <span class="badge">${escapeHtml(sub)}</span>`;
    } else if (Array.isArray(v)) {
      // –º–∞—Å–∏–≤ (IMReadiness —Ç–æ—â–æ)
      let content;
      if (v.length && typeof v[0] === 'object') {
        content = v.map(item =>
          Object.entries(item).map(([kk,vv]) => `${kk}: ${vv}`).join(', ')
        ).join(' | ');
      } else {
        content = v.join(', ');
      }
      row.innerHTML = `<b>${k}:</b> <span class="badge">${escapeHtml(content)}</span>`;
    } else {
      // –ø—Ä–æ—Å—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è
      row.innerHTML = `<b>${k}:</b> <span class="badge">${escapeHtml(String(v))}</span>`;
    }

    kvEl.appendChild(row);
  };

  if (!obj || !Object.keys(obj).length) {
    add('–°—Ç–∞—Ç—É—Å','–ù–µ–º–∞—î —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏—Ö –ø–æ–ª—ñ–≤');
    return;
  }

  Object.entries(obj).forEach(([k,v]) => {
    if (k !== 'OCRText') add(k, v);
  });

  // –°–∏—Ä–∏–π OCR‚Äë—Ç–µ–∫—Å—Ç –æ–∫—Ä–µ–º–æ
  if (obj.OCRText) {
    const details = document.createElement('details');
    details.className = 'debug';
    const sum = document.createElement('summary');
    sum.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ —Å–∏—Ä–∏–π OCR‚Äë—Ç–µ–∫—Å—Ç';
    const pre = document.createElement('pre');
    pre.textContent = obj.OCRText;
    details.appendChild(sum);
    details.appendChild(pre);
    kvEl.appendChild(details);
  }
}



function renderAdvice(arr){
  const adviceEl = document.getElementById('advice');
  const statusText = document.getElementById('statusText');
  adviceEl.innerHTML = '';
  if (!arr.length) {
    const li = document.createElement('li');
    li.textContent = '–ü—Ä–æ–±–ª–µ–º –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ.';
    adviceEl.appendChild(li);
  } else {
    arr.forEach(x=>{
      const li = document.createElement('li'); li.textContent = x; adviceEl.appendChild(li);
    });
  }
  statusText.textContent = '–ì–æ—Ç–æ–≤–æ';
}
async function renderDTCBase(){
  const dtcBaseView = document.getElementById('dtcBaseView');
  dtcBaseView.innerHTML = '';
  const all = await dbGetAll('dtc');
  const keys = all.map(x=>x.code).sort();
  if (!keys.length) {
    const d1 = document.createElement('div'); d1.textContent = '‚Äî';
    const d2 = document.createElement('div'); d2.textContent = '–ë–∞–∑–∞ –ø–æ—Ä–æ–∂–Ω—è';
    dtcBaseView.appendChild(d1); dtcBaseView.appendChild(d2);
    return;
  }
  keys.slice(0, 30).forEach(code=>{
    const rec = all.find(x=>x.code===code);
    const kEl = document.createElement('div'); kEl.textContent = code;
    const vEl = document.createElement('div');
    vEl.innerHTML = `<span class="badge">${escapeHtml(rec.name||'')}</span> <span class="small">${escapeHtml(rec.desc||'')}</span>`;
    dtcBaseView.appendChild(kEl); dtcBaseView.appendChild(vEl);
  });
  if (keys.length > 30) {
    const moreK = document.createElement('div'); moreK.textContent = '‚Ä¶';
    const moreV = document.createElement('div'); moreV.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ 30 –∑ ${keys.length} –∑–∞–ø–∏—Å—ñ–≤`;
    dtcBaseView.appendChild(moreK); dtcBaseView.appendChild(moreV);
  }
}

/* ========= DB import/export ========= */
downloadDB.addEventListener('click', async ()=>{
  const dtc = await dbGetAll('dtc');
  const series = await dbGetAll('series');
  const payload = { dtc, series, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'obd_analyzer_db.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
importFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  try {
    const data = JSON.parse(text);
    await dbDeleteAll('dtc'); await dbDeleteAll('series');
    if (Array.isArray(data.dtc)) for (const rec of data.dtc) await dbPut('dtc', rec);
    if (Array.isArray(data.series)) for (const s of data.series) await dbPut('series', s);
    await renderDTCBase(); await refreshCharts();
    alert('–Ü–º–ø–æ—Ä—Ç –≤–∏–∫–æ–Ω–∞–Ω–æ');
  } catch(err) { alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É'); }
});

/* ========= Utils ========= */
function escapeHtml(s){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
function renderResult(parsed, tips){
  // –ø–æ–∫–∞–∑–∞—Ç–∏ —É—Å—ñ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω—ñ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–Ω—è
  renderKV(parsed);
  // –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ä–∞–¥–∏
  renderAdvice(tips);
  // –ø–æ–∫–∞–∑–∞—Ç–∏ —Å–∏—Ä–∏–π OCR‚Äë—Ç–µ–∫—Å—Ç (—è–∫—â–æ —î)
  if (parsed.OCRText) {
    const details = document.createElement('details');
    details.className = 'debug';
    const sum = document.createElement('summary');
    sum.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ —Å–∏—Ä–∏–π OCR‚Äë—Ç–µ–∫—Å—Ç';
    const pre = document.createElement('pre');
    pre.textContent = parsed.OCRText;
    details.appendChild(sum);
    details.appendChild(pre);
    quickSummary.appendChild(details);
  }
  // –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
  statusText.textContent = '–ì–æ—Ç–æ–≤–æ';
  // —à–≤–∏–¥–∫—ñ –ø—ñ–¥—Å—É–º–∫–∏ —É –≤–∏–≥–ª—è–¥—ñ ¬´–ø—ñ–ª–ª—ñ–≤¬ª
  quickSummary.innerHTML = '';

  if (Array.isArray(parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫) && parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫.length) {
    const pill = document.createElement('div');
    pill.className='pill';
    pill.textContent = `DTC: ${parsed.–ö–æ–¥–∏–ü–æ–º–∏–ª–æ–∫.join(', ')}`;
    quickSummary.appendChild(pill);
  }
  if (typeof parsed.–û–±–æ—Ä–æ—Ç–∏ === 'number') {
    const pill = document.createElement('div');
    pill.className='pill';
    pill.textContent = `RPM: ${parsed.–û–±–æ—Ä–æ—Ç–∏}`;
    quickSummary.appendChild(pill);
  }
  if (typeof parsed.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ === 'number') {
    const pill = document.createElement('div');
    pill.className='pill';
    pill.textContent = `ECT: ${parsed.–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞–û–ñ}¬∞C`;
    quickSummary.appendChild(pill);
  }
  if (typeof parsed.–¢–∏—Å–∫MAP_kPa === 'number') {
    const pill = document.createElement('div');
    pill.className='pill';
    pill.textContent = `MAP: ${parsed.–¢–∏—Å–∫MAP_kPa} kPa`;
    quickSummary.appendChild(pill);
  }
  if (typeof parsed.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs === 'number') {
    const pill = document.createElement('div');
    pill.className='pill';
    pill.textContent = `MAF: ${parsed.–ú–∞—Å–æ–≤–∞–í–∏—Ç—Ä–∞—Ç–∞–ü–æ–≤—ñ—Ç—Ä—è_gs} g/s`;
    quickSummary.appendChild(pill);
  }
  if (typeof parsed.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫ === 'number') {
    const pill = document.createElement('div');
    pill.className='pill';
    pill.textContent = `TPS: ${parsed.–ü–æ–ª–æ–∂–µ–Ω–Ω—è–î—Ä–æ—Å–µ–ª—è–í—ñ–¥—Å–æ—Ç–æ–∫}%`;
    quickSummary.appendChild(pill);
  }  
}



function renderAdvice(arr){
  adviceEl.innerHTML = '';
  if (!arr.length) {
    const li = document.createElement('li');
    li.textContent = '–ü—Ä–æ–±–ª–µ–º –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ.';
    adviceEl.appendChild(li);
    return;
  }
  arr.forEach(x=>{
    const li = document.createElement('li');
    li.textContent = x;
    adviceEl.appendChild(li);
  });
}

</script>
</body>
</html>
